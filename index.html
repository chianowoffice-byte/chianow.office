<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thu Thập Dữ Liệu HKD</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Thư viện jsQR để đọc mã QR trên ảnh (Client-side) -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-mobile {
            max-width: 600px;
            margin: 0 auto;
            min-height: 10vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            background-color: #ffffff;
        }
        .step-section {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5), 0 4px 6px -4px rgba(37, 99, 235, 0.5);
            transform: translateY(-2px);
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = 'anonymous';

        // Function to initialize Firebase and sign in
        window.initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                return;
            }
            try {
                // setLogLevel('Debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = 'Đã xác thực. User ID: ' + userId.substring(0, 8) + '...';
                        console.log("Firebase initialized. User ID:", userId);
                        // Store Cán Bộ info for auto-fill on next run
                        localStorage.setItem('currentUserId', userId);
                    } else {
                        userId = localStorage.getItem('currentUserId') || crypto.randomUUID(); // Fallback to a random ID
                        document.getElementById('auth-status').textContent = 'Ẩn danh. User ID: ' + userId.substring(0, 8) + '...';
                        console.log("Signed out. Using anonymous ID:", userId);
                    }
                    loadCanBoInfo(); // Load saved Can Bo info after auth setup
                });

                window.db = db; // Attach to window for use in the main script
                window.userId = userId;

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('auth-status').textContent = 'Lỗi xác thực: ' + error.code;
            }
        };

        // Function to save data to Firestore
        window.saveData = async (data) => {
            if (!db || !userId) {
                showToast('Lỗi: Chưa kết nối Firebase hoặc User ID.', 'bg-red-500');
                return false;
            }
            try {
                // Lưu dữ liệu vào collection private của người dùng
                const docRef = await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/hkd_data`), {
                    ...data,
                    timestamp: serverTimestamp(),
                    collector_id: userId,
                });
                showToast('Lưu dữ liệu thành công!', 'bg-green-500');
                return true;
            } catch (e) {
                console.error("Lỗi khi thêm tài liệu vào Firestore: ", e);
                showToast('Lỗi khi lưu dữ liệu vào Firestore.', 'bg-red-500');
                return false;
            }
        };
        
        // Function to show toast notification
        window.showToast = (message, color = 'bg-gray-800') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 ${color} text-white px-4 py-2 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-100`;
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        };

        // Function to save and load Can Bo info using localStorage
        window.saveCanBoInfo = () => {
            const maCB = document.getElementById('Ma_CB').value;
            const tenCB = document.getElementById('Ten_CB').value;
            const emailCB = document.getElementById('Email_CB').value;
            const tenPhong = document.getElementById('Ten_Phong').value;

            if (maCB) {
                localStorage.setItem('canBoInfo', JSON.stringify({ maCB, tenCB, emailCB, tenPhong }));
            }
        };

        window.loadCanBoInfo = () => {
            const savedInfo = localStorage.getItem('canBoInfo');
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                document.getElementById('Ma_CB').value = info.maCB || '';
                document.getElementById('Ten_CB').value = info.tenCB || '';
                document.getElementById('Email_CB').value = info.emailCB || '';
                document.getElementById('Ten_Phong').value = info.tenPhong || '';
            }
        };
        
        /**
         * Chức năng ĐỌC MÃ QR trên ảnh chụp CCCD (Client-side)
         */
        
        // Hàm xử lý ảnh: Tăng cường độ tương phản và nhị phân hóa (lấy ý tưởng từ code Python)
        function processImageForQR(context, width, height) {
            let imageData = context.getImageData(0, 0, width, height);
            let data = imageData.data;
            
            // Chuyển sang grayscale và tăng cường tương phản (giả lập autoboost)
            for (let i = 0; i < data.length; i += 4) {
                let r = data[i];
                let g = data[i + 1];
                let b = data[i + 2];
                let avg = (r + g + b) / 3;

                // Tăng cường tương phản nhẹ (ví dụ: bình phương giá trị)
                let enhanced = Math.min(255, Math.pow(avg / 255, 0.7) * 255); 
                
                // Nhị phân hóa (threshold 128)
                let bw = enhanced > 128 ? 255 : 0;
                
                data[i] = bw;      // red
                data[i + 1] = bw;  // green
                data[i + 2] = bw;  // blue
            }
            context.putImageData(imageData, 0, 0);
        }

        // Hàm phân tích chuỗi QR CCCD (Dạng phổ biến: ID|HọTên|NgàySinh|GiớiTính|ĐịaChỉ|NgàyCấp|...)
        function parseCCCDPayload(qrString) {
            const parts = qrString.split('|').map(p => p.trim());
            const keys = ["So_Can_cuoc_CCCD", "Ho_va_ten", "Ngay_sinh", "Gioi_tinh", "Dia_chi_chu_ho", "Ngay_cap", "Noi_cap"];
            const result = {};

            // Nếu chuỗi QR có ít nhất 6 trường (CCCD, Tên, NS, GT, DC, NC)
            if (parts.length >= 6) {
                result.So_Can_cuoc_CCCD = parts[0];
                result.Ho_va_ten = parts[2];
                result.Ngay_sinh = parts[3]; // Yêu cầu người dùng chỉnh format sau
                result.Gioi_tinh = parts[4];
                result.Dia_chi_chu_ho = parts[5];
                result.Ngay_cap = parts[6];
                result.Noi_cap = parts[1]; // Mã Tỉnh/Thành phố
            } else {
                 // Nếu không theo format chuẩn, chỉ điền ID và Tên (nếu tìm thấy)
                 result.So_Can_cuoc_CCCD = parts[0] || '';
                 result.Ho_va_ten = parts[2] || '';
            }
            
            return result;
        }

        window.readQRData = (inputId) => {
            const fileInput = document.getElementById(inputId);
            const rawDataField = document.getElementById('Raw_QR_Data');
            const loader = document.getElementById('qrLoader');
            const button = document.getElementById('readQRButton');
            const originalButtonText = button.textContent.trim();

            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Vui lòng chụp ảnh CCCD trước khi đọc mã QR.', 'bg-yellow-500');
                return;
            }
            
            loader.classList.remove('hidden');
            button.disabled = true;
            button.textContent = 'Đang xử lý...';
            rawDataField.value = 'Đang cố gắng đọc mã QR...';

            const file = fileInput.files[0];
            const reader = new FileReader();
            
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');

            const processQR = new Promise((resolve, reject) => {
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        try {
                            canvas.width = img.width;
                            canvas.height = img.height;
                            context.drawImage(img, 0, 0, img.width, img.height);
                            
                            // 1. Thử đọc QR trực tiếp trên ảnh gốc (chỉ cần vẽ lại lên canvas)
                            let imageData = context.getImageData(0, 0, img.width, img.height);
                            let code = jsQR(imageData.data, imageData.width, imageData.height);
                            
                            if (code) {
                                resolve(code);
                                return;
                            }
                            
                            // 2. Thử đọc QR sau khi tăng cường và nhị phân hóa (mô phỏng autoboost)
                            context.drawImage(img, 0, 0, img.width, img.height); // Reset canvas
                            processImageForQR(context, img.width, img.height);
                            imageData = context.getImageData(0, 0, img.width, img.height);
                            code = jsQR(imageData.data, imageData.width, imageData.height);

                            resolve(code);
                            
                        } catch (error) {
                            reject('Lỗi xử lý hình ảnh trên canvas.');
                        }
                    };
                    img.onerror = (err) => { reject('Lỗi tải ảnh.'); };
                    img.src = e.target.result;
                };
                reader.onerror = (err) => { reject('Lỗi đọc file ảnh.'); };
                reader.readAsDataURL(file);
            });


            processQR.then(code => {
                loader.classList.add('hidden');
                button.disabled = false;
                button.textContent = originalButtonText;
                
                if (code && code.data) {
                    const qrString = code.data;
                    rawDataField.value = qrString;
                    showToast('Đọc mã QR thành công! Đang tự động điền thông tin.', 'bg-green-600');
                    
                    // PHÂN TÍCH CHUỖI VÀ ĐIỀN VÀO FORM
                    const parsedData = parseCCCDPayload(qrString);
                    
                    document.getElementById('So_Can_cuoc_CCCD').value = parsedData.So_Can_cuoc_CCCD || '';
                    document.getElementById('Ho_va_ten').value = parsedData.Ho_va_ten || '';
                    document.getElementById('Gioi_tinh').value = parsedData.Gioi_tinh || '';
                    document.getElementById('Dia_chi_chu_ho').value = parsedData.Dia_chi_chu_ho || '';
                    
                    // Lưu ý: Ngay_sinh, Ngay_cap cần format YYYY-MM-DD
                    document.getElementById('Ngay_sinh').value = parsedData.Ngay_sinh ? parsedData.Ngay_sinh.split('/').reverse().join('-') : '';
                    document.getElementById('Ngay_cap').value = parsedData.Ngay_cap ? parsedData.Ngay_cap.split('/').reverse().join('-') : '';
                    document.getElementById('Noi_cap').value = parsedData.Noi_cap || '';
                    
                    showToast('Đã tự động điền các trường chính. Vui lòng kiểm tra lại!', 'bg-green-600');
                    
                } else {
                    rawDataField.value = 'Không tìm thấy mã QR nào trong ảnh. Vui lòng thử lại với ảnh rõ hơn.';
                    showToast('Lỗi: Không tìm thấy mã QR. Ảnh phải rõ và đủ sáng.', 'bg-red-500');
                }
            }).catch(error => {
                loader.classList.add('hidden');
                button.disabled = false;
                button.textContent = originalButtonText;
                console.error("Lỗi quá trình quét QR:", error);
                rawDataField.value = `Lỗi xử lý ảnh: ${error}`;
                showToast(`Lỗi quét QR: ${error}`, 'bg-red-500');
            });
        };
        
        // Hàm reset file input
        const fileInputReset = (id) => {
            const input = document.getElementById(id);
            input.value = null; 
        };
        
        
        /**
         * Thu thập dữ liệu từ Form và gửi lên Firestore.
         */
        window.submitForm = async () => {
            // Lưu thông tin cán bộ trước
            saveCanBoInfo();

            // 1. Thu thập dữ liệu
            const data = {
                // Cán Bộ (Data CB)
                "Ma_CB": document.getElementById('Ma_CB').value,
                "Ten_CB": document.getElementById('Ten_CB').value,
                "Email_CB": document.getElementById('Email_CB').value, 
                "Ten_Phong": document.getElementById('Ten_Phong').value, 
                
                // Chủ Hộ / HKD (Data HKD)
                "Ho_va_ten": document.getElementById('Ho_va_ten').value,
                "Gioi_tinh": document.getElementById('Gioi_tinh').value,
                "Ngay_sinh": document.getElementById('Ngay_sinh').value,
                "So_Can_cuoc_CCCD": document.getElementById('So_Can_cuoc_CCCD').value,
                "Ngay_cap": document.getElementById('Ngay_cap').value,
                "Noi_cap": document.getElementById('Noi_cap').value,
                "Email": document.getElementById('Email').value,
                "SDT_chu_ho": document.getElementById('SDT_chu_ho').value,
                "Dia_chi_chu_ho": document.getElementById('Dia_chi_chu_ho').value,
                
                "Ten_ho_kinh_doanh": document.getElementById('Ten_ho_kinh_doanh').value,
                "So_DKKD": document.getElementById('So_DKKD').value,
                "Ngay_cap_lan_dau": document.getElementById('Ngay_cap_lan_dau').value,
                "Ngay_dieu_chinh_gan_nhat": document.getElementById('Ngay_dieu_chinh_gan_nhat').value,
                "Ma_so_thue": document.getElementById('Ma_so_thue').value,
                "Linh_vuc_kinh_doanh": document.getElementById('Linh_vuc_kinh_doanh').value,
                "Dia_chi_HKD": document.getElementById('Dia_chi_HKD').value,
                "Email_HKD": document.getElementById('Email_HKD').value,
                "SDT_HKD": document.getElementById('SDT_HKD').value,
                
                // Dữ liệu QR thô
                "Raw_QR_Data": document.getElementById('Raw_QR_Data').value,

                // Thêm các trường tiến độ mặc định
                "Trang_Thai_Tien_Do": "Mới thu thập",
                "Has_CCCD_Image": document.getElementById('cccdImageInput').files.length > 0,
                "Has_HKD_Image": document.getElementById('hkdImageInput').files.length > 0,
            };

            // 2. Kiểm tra dữ liệu cần thiết (Các trường có dấu *)
            if (!data.Ma_CB || !data.Ho_va_ten || !data.So_Can_cuoc_CCCD || !data.SDT_chu_ho || !data.Ma_so_thue) {
                showToast('Vui lòng nhập đủ các trường chính có dấu * (Mã CB, Tên, CCCD, SĐT, MST).', 'bg-red-500');
                return;
            }

            // 3. Lưu vào Firestore
            const success = await saveData(data);

            // 4. Reset Form sau khi lưu thành công
            if (success) {
                // Chỉ reset các trường thông tin HKD/Chủ hộ
                document.getElementById('Ho_va_ten').value = '';
                document.getElementById('Gioi_tinh').value = '';
                document.getElementById('Ngay_sinh').value = '';
                document.getElementById('So_Can_cuoc_CCCD').value = '';
                document.getElementById('Ngay_cap').value = '';
                document.getElementById('Noi_cap').value = '';
                document.getElementById('Email').value = '';
                document.getElementById('SDT_chu_ho').value = '';
                document.getElementById('Dia_chi_chu_ho').value = '';
                document.getElementById('Raw_QR_Data').value = ''; // Reset QR Data
                
                document.getElementById('Ten_ho_kinh_doanh').value = '';
                document.getElementById('So_DKKD').value = '';
                document.getElementById('Ngay_cap_lan_dau').value = '';
                document.getElementById('Ngay_dieu_chinh_gan_nhat').value = '';
                document.getElementById('Ma_so_thue').value = '';
                document.getElementById('Linh_vuc_kinh_doanh').value = '';
                document.getElementById('Dia_chi_HKD').value = '';
                document.getElementById('Email_HKD').value = '';
                document.getElementById('SDT_HKD').value = '';
                
                // Ẩn ảnh preview và reset file input
                document.getElementById('cccdImagePreview').classList.add('hidden');
                document.getElementById('hkdImagePreview').classList.add('hidden');
                fileInputReset('cccdImageInput');
                fileInputReset('hkdImageInput');
                
                showToast('Dữ liệu HKD mới đã được lưu và Form đã sẵn sàng cho hộ tiếp theo.', 'bg-green-600');
            }
        };
        
    </script>
</body>
</html>
