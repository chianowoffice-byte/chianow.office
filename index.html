<!DOCTYPE html>
<html lang="vi">
<head><!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thu Thập Dữ Liệu HKD</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-mobile {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            background-color: #ffffff;
        }
        .step-section {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5), 0 4px 6px -4px rgba(37, 99, 235, 0.5);
            transform: translateY(-2px);
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = 'anonymous';

        // Function to initialize Firebase and sign in
        window.initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                return;
            }
            try {
                // setLogLevel('Debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = 'Đã xác thực. User ID: ' + userId.substring(0, 8) + '...';
                        console.log("Firebase initialized. User ID:", userId);
                        // Store Cán Bộ info for auto-fill on next run
                        localStorage.setItem('currentUserId', userId);
                    } else {
                        userId = localStorage.getItem('currentUserId') || crypto.randomUUID(); // Fallback to a random ID
                        document.getElementById('auth-status').textContent = 'Ẩn danh. User ID: ' + userId.substring(0, 8) + '...';
                        console.log("Signed out. Using anonymous ID:", userId);
                    }
                    loadCanBoInfo(); // Load saved Can Bo info after auth setup
                });

                window.db = db; // Attach to window for use in the main script
                window.userId = userId;

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('auth-status').textContent = 'Lỗi xác thực: ' + error.code;
            }
        };

        // Function to save data to Firestore
        window.saveData = async (data) => {
            if (!db || !userId) {
                showToast('Lỗi: Chưa kết nối Firebase hoặc User ID.', 'bg-red-500');
                return false;
            }
            try {
                // Lưu dữ liệu vào collection private của người dùng
                const docRef = await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/hkd_data`), {
                    ...data,
                    timestamp: serverTimestamp(),
                    collector_id: userId,
                });
                showToast('Lưu dữ liệu thành công!', 'bg-green-500');
                return true;
            } catch (e) {
                console.error("Lỗi khi thêm tài liệu vào Firestore: ", e);
                showToast('Lỗi khi lưu dữ liệu vào Firestore.', 'bg-red-500');
                return false;
            }
        };
        
        // Function to show toast notification
        window.showToast = (message, color = 'bg-gray-800') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 ${color} text-white px-4 py-2 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-100`;
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        };

        // Function to save and load Can Bo info using localStorage
        window.saveCanBoInfo = () => {
            const maCB = document.getElementById('Ma_CB').value;
            const tenCB = document.getElementById('Ten_CB').value;
            const emailCB = document.getElementById('Email_CB').value;
            const tenPhong = document.getElementById('Ten_Phong').value;

            if (maCB) {
                localStorage.setItem('canBoInfo', JSON.stringify({ maCB, tenCB, emailCB, tenPhong }));
            }
        };

        window.loadCanBoInfo = () => {
            const savedInfo = localStorage.getItem('canBoInfo');
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                document.getElementById('Ma_CB').value = info.maCB || '';
                document.getElementById('Ten_CB').value = info.tenCB || '';
                document.getElementById('Email_CB').value = info.emailCB || '';
                document.getElementById('Ten_Phong').value = info.tenPhong || '';
            }
        };
    </script>
</head>
<body onload="initFirebase()">

    <div class="container-mobile">
        <!-- Header -->
        <header class="p-4 bg-blue-600 text-white shadow-lg sticky top-0 z-10 rounded-b-lg">
            <h1 class="text-xl font-bold">Thu Thập Hộ Kinh Doanh</h1>
            <p id="auth-status" class="text-xs mt-1 opacity-80">Đang khởi tạo...</p>
        </header>

        <main class="p-4 flex-grow">
            <!-- Step 1: Thông tin Cán Bộ -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    1. Thông tin Cán Bộ (Auto-Saved)
                </h2>
                <div class="space-y-3">
                    <input type="text" id="Ma_CB" placeholder="Mã CB *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                    <input type="text" id="Ten_CB" placeholder="Tên CB" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                    <input type="email" id="Email_CB" placeholder="Email CB" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                    <input type="text" id="Ten_Phong" placeholder="Tên Phòng" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                </div>
            </div>

            <!-- Step 2: Quét/Trích xuất CCCD -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    2. Chụp & Trích xuất CCCD
                </h2>
                <input type="file" accept="image/*" capture="camera" id="cccdImageInput" class="hidden" onchange="previewImage('cccdImageInput', 'cccdImagePreview')">
                <button onclick="document.getElementById('cccdImageInput').click()" class="btn-primary w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.868-1.298A2 2 0 0110.456 5h3.088a2 2 0 011.664.89l.868 1.298A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Chụp Ảnh CCCD
                </button>
                <img id="cccdImagePreview" class="mt-3 w-full rounded-lg hidden border-2 border-gray-200">
                
                <button id="extractCCCDButton" onclick="extractText('cccdImageInput', 'cccd')" class="btn-primary w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-3 flex items-center justify-center">
                    <div id="cccdLoader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>
                    Trích Xuất Thông Tin CCCD
                </button>
            </div>

            <!-- Step 3: Thông tin Chủ Hộ (Kết quả Trích xuất) -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-5m-15-6h14a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2z"></path></svg>
                    3. Thông tin Chủ Hộ
                </h2>
                <div class="space-y-3">
                    <input type="text" id="Ho_va_ten" placeholder="Họ và tên *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Gioi_tinh" placeholder="Giới tính" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="date" id="Ngay_sinh" placeholder="Ngày sinh" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="So_Can_cuoc_CCCD" placeholder="Số Căn cước /CCCD *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="date" id="Ngay_cap" placeholder="Ngày cấp" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Noi_cap" placeholder="Nơi cấp" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="email" id="Email" placeholder="Email chủ hộ" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" id="SDT_chu_ho" placeholder="SĐT chủ hộ *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="Dia_chi_chu_ho" placeholder="Địa chỉ chủ hộ" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>

            <!-- Step 4: Chụp & Trích xuất Giấy Đăng ký HKD -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    4. Chụp & Trích xuất Đăng Ký HKD
                </h2>
                <input type="file" accept="image/*" capture="camera" id="hkdImageInput" class="hidden" onchange="previewImage('hkdImageInput', 'hkdImagePreview')">
                <button onclick="document.getElementById('hkdImageInput').click()" class="btn-primary w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.868-1.298A2 2 0 0110.456 5h3.088a2 2 0 011.664.89l.868 1.298A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Chụp Ảnh Đăng Ký HKD
                </button>
                <img id="hkdImagePreview" class="mt-3 w-full rounded-lg hidden border-2 border-gray-200">

                <button id="extractHKDButton" onclick="extractText('hkdImageInput', 'hkd')" class="btn-primary w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-3 flex items-center justify-center">
                    <div id="hkdLoader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>
                    Trích Xuất Thông Tin HKD
                </button>
            </div>

            <!-- Step 5: Thông tin Hộ Kinh Doanh (Kết quả Trích xuất) -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a2 2 0 002 2h4a2 2 0 002-2V7m0 10a2 2 0 002 2H6a2 2 0 01-2-2v-4a2 2 0 012-2h12a2 2 0 012 2v4z"></path></svg>
                    5. Thông tin Hộ Kinh Doanh
                </h2>
                <div class="space-y-3">
                    <input type="text" id="Ten_ho_kinh_doanh" placeholder="Tên hộ kinh doanh" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="So_DKKD" placeholder="Số ĐKKD" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="date" id="Ngay_cap_lan_dau" placeholder="Ngày cấp lần đầu" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Ngay_dieu_chinh_gan_nhat" placeholder="Ngày điều chỉnh gần nhất (nếu có)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Ma_so_thue" placeholder="Mã số thuế *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Linh_vuc_kinh_doanh" placeholder="Lĩnh vực kinh doanh" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="Dia_chi_HKD" placeholder="Địa chỉ HKD" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <input type="email" id="Email_HKD" placeholder="Email HKD" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" id="SDT_HKD" placeholder="SĐT HKD" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- Step 6: Hành động -->
            <div class="step-section bg-blue-50 border-blue-200 border">
                <button onclick="submitForm()" class="btn-primary w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center text-lg">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    LƯU DỮ LIỆU & TIẾP TỤC
                </button>
            </div>
        </main>
        
        <footer class="p-3 text-center text-xs text-gray-500">
            Powered by Gemini AI for OCR & Firestore
        </footer>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0"></div>

    <script type="module">
        // Global functions are attached to window in the module import block
        
        /**
         * Chuyển đổi File ảnh thành base64.
         * @param {File} file - File ảnh từ input.
         * @returns {Promise<string>} Base64 data (không bao gồm prefix).
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        /**
         * Hiển thị ảnh preview sau khi chụp.
         */
        window.previewImage = (inputId, previewId) => {
            const file = document.getElementById(inputId).files[0];
            const preview = document.getElementById(previewId);
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.classList.add('hidden');
            }
        };

        // Hàm giúp định dạng ngày tháng sang YYYY-MM-DD nếu có thể (cho input type=date)
        const formatDateForInput = (dateString) => {
            if (!dateString) return '';
            // Chuỗi ngày tháng có thể là DD/MM/YYYY, DD-MM-YYYY, hoặc YYYY-MM-DD
            const parts = dateString.match(/(\d{1,4})[/-](\d{1,2})[/-](\d{2,4})/);
            if (parts) {
                const p1 = parts[1]; // Ngày hoặc Năm
                const p2 = parts[2]; // Tháng
                const p3 = parts[3]; // Năm hoặc Ngày

                let year, month, day;

                // Logic đơn giản để đoán định dạng DD/MM/YYYY hoặc MM/DD/YYYY
                // Giả định định dạng phổ biến ở VN là DD/MM/YYYY
                if (p1.length <= 2 && p3.length === 4) { // D/M/YYYY (Phổ biến)
                    day = p1.padStart(2, '0');
                    month = p2.padStart(2, '0');
                    year = p3;
                } else if (p1.length === 4) { // YYYY/MM/DD
                    year = p1;
                    month = p2.padStart(2, '0');
                    day = p3.padStart(2, '0');
                } else { // Trường hợp khác, sử dụng chuỗi gốc và để người dùng chỉnh sửa
                    return dateString;
                }

                return `${year}-${month}-${day}`; 
            }
            // Trả về chuỗi gốc nếu không khớp định dạng, để người dùng tự chỉnh sửa.
            return dateString; 
        };

        /**
         * Gọi API Gemini để trích xuất văn bản từ ảnh.
         * @param {string} inputId - ID của input file.
         * @param {string} docType - Loại tài liệu ('cccd' hoặc 'hkd').
         */
        window.extractText = async (inputId, docType) => {
            const fileInput = document.getElementById(inputId);
            
            // KIỂM TRA QUAN TRỌNG: Đảm bảo có file được chọn
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Vui lòng chụp ảnh hoặc chọn file trước khi trích xuất.', 'bg-yellow-500');
                return;
            }

            const loaderId = docType === 'cccd' ? 'cccdLoader' : 'hkdLoader';
            const buttonId = docType === 'cccd' ? 'extractCCCDButton' : 'extractHKDButton';
            const loader = document.getElementById(loaderId);
            const button = document.getElementById(buttonId);
            const originalButtonText = button.textContent.trim();

            // Set loading state
            loader.classList.remove('hidden');
            button.disabled = true;
            button.textContent = (docType === 'cccd' ? 'Đang trích xuất CCCD...' : 'Đang trích xuất HKD...');
            
            try {
                const base64Data = await fileToBase64(fileInput.files[0]);
                
                let prompt;
                let responseSchema;

                if (docType === 'cccd') {
                    // Cập nhật Prompt: Yêu cầu trả về ngày tháng dưới dạng chuỗi nguyên gốc.
                    prompt = `Phân tích văn bản trong ảnh là Căn cước công dân. Trích xuất chính xác các thông tin sau: 1. Họ và tên (FULL_NAME), 2. Giới tính (GENDER), 3. Ngày sinh (BIRTH_DATE), 4. Số Căn cước/CCCD (ID_NUMBER), 5. Ngày cấp (ISSUE_DATE), 6. Nơi cấp (ISSUE_PLACE). Trả lời chỉ dưới dạng JSON.`;
                    responseSchema = {
                        type: "OBJECT",
                        properties: {
                            "FULL_NAME": { "type": "STRING" },
                            "GENDER": { "type": "STRING" },
                            "BIRTH_DATE": { "type": "STRING" },
                            "ID_NUMBER": { "type": "STRING" },
                            "ISSUE_DATE": { "type": "STRING" },
                            "ISSUE_PLACE": { "type": "STRING" }
                        }
                    };
                } else { // HKD
                    // Cập nhật Prompt: Yêu cầu trả về ngày tháng dưới dạng chuỗi nguyên gốc.
                    prompt = `Phân tích văn bản trong ảnh là Giấy đăng ký Hộ kinh doanh. Trích xuất chính xác các thông tin sau: 1. Tên hộ kinh doanh (HKD_NAME), 2. Số ĐKKD (DKKD_NUMBER), 3. Ngày cấp lần đầu (FIRST_ISSUE_DATE), 4. Ngày điều chỉnh gần nhất (LAST_ADJUST_DATE), 5. Mã số thuế (MST), 6. Lĩnh vực kinh doanh (BUSINESS_FIELD), 7. Địa chỉ HKD (HKD_ADDRESS). Trả lời chỉ dưới dạng JSON.`;
                    responseSchema = {
                        type: "OBJECT",
                        properties: {
                            "HKD_NAME": { "type": "STRING" },
                            "DKKD_NUMBER": { "type": "STRING" },
                            "FIRST_ISSUE_DATE": { "type": "STRING" },
                            "LAST_ADJUST_DATE": { "type": "STRING" },
                            "MST": { "type": "STRING" },
                            "BUSINESS_FIELD": { "type": "STRING" },
                            "HKD_ADDRESS": { "type": "STRING" }
                        }
                    };
                }
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: fileInput.files[0].type,
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    }
                };
                
                // Retry mechanism for API call (Exponential Backoff)
                const maxRetries = 5;
                let attempt = 0;
                let apiResponse;

                while (attempt < maxRetries) {
                    attempt++;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                             throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        apiResponse = await response.json();
                        if (apiResponse.candidates && apiResponse.candidates.length > 0) {
                            break; // Success
                        } else {
                            // API call succeeded but no candidate was returned (e.g., safety block or empty response)
                            console.error("API returned no candidates:", apiResponse);
                            if (attempt < maxRetries) {
                                await new Promise(resolve => setTimeout(resolve, 2 ** attempt * 1000));
                                continue;
                            } else {
                                throw new Error("API failed to return content after multiple retries.");
                            }
                        }
                    } catch (error) {
                        console.warn(`Attempt ${attempt} failed. Retrying in ${2 ** attempt}s...`);
                        if (attempt < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 2 ** attempt * 1000));
                        } else {
                            throw new Error("Failed after multiple retries.");
                        }
                    }
                }
                
                // Process the successful response
                if (apiResponse.candidates && apiResponse.candidates.length > 0) {
                    const jsonText = apiResponse.candidates[0].content.parts[0].text;
                    const result = JSON.parse(jsonText);
                    
                    if (docType === 'cccd') {
                        document.getElementById('Ho_va_ten').value = result.FULL_NAME || '';
                        document.getElementById('Gioi_tinh').value = result.GENDER || '';
                        // Sử dụng hàm formatDateForInput để chuyển đổi định dạng
                        document.getElementById('Ngay_sinh').value = formatDateForInput(result.BIRTH_DATE) || '';
                        document.getElementById('So_Can_cuoc_CCCD').value = result.ID_NUMBER || '';
                        document.getElementById('Ngay_cap').value = formatDateForInput(result.ISSUE_DATE) || '';
                        document.getElementById('Noi_cap').value = result.ISSUE_PLACE || '';
                        showToast('Trích xuất CCCD thành công. Vui lòng kiểm tra lại dữ liệu!', 'bg-green-600');
                    } else {
                        document.getElementById('Ten_ho_kinh_doanh').value = result.HKD_NAME || '';
                        document.getElementById('So_DKKD').value = result.DKKD_NUMBER || '';
                        document.getElementById('Ngay_cap_lan_dau').value = formatDateForInput(result.FIRST_ISSUE_DATE) || '';
                        document.getElementById('Ngay_dieu_chinh_gan_nhat').value = result.LAST_ADJUST_DATE || '';
                        document.getElementById('Ma_so_thue').value = result.MST || '';
                        document.getElementById('Linh_vuc_kinh_doanh').value = result.BUSINESS_FIELD || '';
                        document.getElementById('Dia_chi_HKD').value = result.HKD_ADDRESS || '';
                        showToast('Trích xuất HKD thành công. Vui lòng kiểm tra lại dữ liệu!', 'bg-green-600');
                    }
                } else {
                    showToast('Lỗi API: Không nhận được kết quả trích xuất.', 'bg-red-500');
                }

            } catch (error) {
                console.error("Lỗi trích xuất bằng Gemini:", error);
                // Hiển thị lỗi chi tiết hơn nếu có thể
                showToast(`Lỗi trích xuất: ${error.message || 'Lỗi không xác định'}. Thử lại hoặc nhập thủ công.`, 'bg-red-500');
            } finally {
                // Reset loading state
                loader.classList.add('hidden');
                button.disabled = false;
                button.textContent = originalButtonText;
            }
        };

        /**
         * Thu thập dữ liệu từ Form và gửi lên Firestore.
         */
        window.submitForm = async () => {
            // Lưu thông tin cán bộ trước
            saveCanBoInfo();

            // 1. Thu thập dữ liệu, sử dụng ID khớp với tên cột của bạn (đã loại bỏ dấu)
            const data = {
                // Cán Bộ (Data CB)
                "Ma_CB": document.getElementById('Ma_CB').value,
                "Ten_CB": document.getElementById('Ten_CB').value,
                "Email_CB": document.getElementById('Email_CB').value, // Thêm để lưu vào Firestore
                "Ten_Phong": document.getElementById('Ten_Phong').value, // Thêm để lưu vào Firestore
                
                // Chủ Hộ / HKD (Data HKD)
                "Ho_va_ten": document.getElementById('Ho_va_ten').value,
                "Gioi_tinh": document.getElementById('Gioi_tinh').value,
                "Ngay_sinh": document.getElementById('Ngay_sinh').value,
                "So_Can_cuoc_CCCD": document.getElementById('So_Can_cuoc_CCCD').value,
                "Ngay_cap": document.getElementById('Ngay_cap').value,
                "Noi_cap": document.getElementById('Noi_cap').value,
                "Email": document.getElementById('Email').value,
                "SDT_chu_ho": document.getElementById('SDT_chu_ho').value,
                "Dia_chi_chu_ho": document.getElementById('Dia_chi_chu_ho').value,
                
                "Ten_ho_kinh_doanh": document.getElementById('Ten_ho_kinh_doanh').value,
                "So_DKKD": document.getElementById('So_DKKD').value,
                "Ngay_cap_lan_dau": document.getElementById('Ngay_cap_lan_dau').value,
                "Ngay_dieu_chinh_gan_nhat": document.getElementById('Ngay_dieu_chinh_gan_nhat').value,
                "Ma_so_thue": document.getElementById('Ma_so_thue').value,
                "Linh_vuc_kinh_doanh": document.getElementById('Linh_vuc_kinh_doanh').value,
                "Dia_chi_HKD": document.getElementById('Dia_chi_HKD').value,
                "Email_HKD": document.getElementById('Email_HKD').value,
                "SDT_HKD": document.getElementById('SDT_HKD').value,

                // Thêm các trường tiến độ mặc định
                "Trang_Thai_Tien_Do": "Mới thu thập",
                "Has_CCCD_Image": document.getElementById('cccdImageInput').files.length > 0,
                "Has_HKD_Image": document.getElementById('hkdImageInput').files.length > 0,
            };

            // 2. Kiểm tra dữ liệu cần thiết (Các trường có dấu *)
            if (!data.Ma_CB || !data.Ho_va_ten || !data.So_Can_cuoc_CCCD || !data.SDT_chu_ho || !data.Ma_so_thue) {
                showToast('Vui lòng nhập đủ các trường chính có dấu * (Mã CB, Tên, CCCD, SĐT, MST).', 'bg-red-500');
                return;
            }

            // 3. Lưu vào Firestore
            const success = await saveData(data);

            // 4. Reset Form sau khi lưu thành công
            if (success) {
                // Chỉ reset các trường thông tin HKD/Chủ hộ
                document.getElementById('Ho_va_ten').value = '';
                document.getElementById('Gioi_tinh').value = '';
                document.getElementById('Ngay_sinh').value = '';
                document.getElementById('So_Can_cuoc_CCCD').value = '';
                document.getElementById('Ngay_cap').value = '';
                document.getElementById('Noi_cap').value = '';
                document.getElementById('Email').value = '';
                document.getElementById('SDT_chu_ho').value = '';
                document.getElementById('Dia_chi_chu_ho').value = '';
                document.getElementById('Ten_ho_kinh_doanh').value = '';
                document.getElementById('So_DKKD').value = '';
                document.getElementById('Ngay_cap_lan_dau').value = '';
                document.getElementById('Ngay_dieu_chinh_gan_nhat').value = '';
                document.getElementById('Ma_so_thue').value = '';
                document.getElementById('Linh_vuc_kinh_doanh').value = '';
                document.getElementById('Dia_chi_HKD').value = '';
                document.getElementById('Email_HKD').value = '';
                document.getElementById('SDT_HKD').value = '';
                
                // Ẩn ảnh preview
                document.getElementById('cccdImagePreview').classList.add('hidden');
                document.getElementById('hkdImagePreview').classList.add('hidden');
                
                // Reset file input 
                fileInputReset('cccdImageInput');
                fileInputReset('hkdImageInput');
                
                showToast('Dữ liệu HKD mới đã được lưu và Form đã sẵn sàng cho hộ tiếp theo.', 'bg-green-600');
            }
        };
        
        // Helper function to reset file input
        const fileInputReset = (id) => {
            const input = document.getElementById(id);
            // Gán lại chính nó để reset state, cách tốt nhất để reset input type="file"
            input.value = null; 
        };
        
    </script>
</body>
</html>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Thu Thập Dữ Liệu HKD</title>
    <!-- Tải Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f4f7f9;
        }
        .container-mobile {
            max-width: 600px;
            margin: 0 auto;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            background-color: #ffffff;
        }
        .step-section {
            background: white;
            padding: 1rem;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
            margin-bottom: 1rem;
        }
        .btn-primary {
            transition: all 0.2s;
        }
        .btn-primary:hover {
            box-shadow: 0 10px 15px -3px rgba(37, 99, 235, 0.5), 0 4px 6px -4px rgba(37, 99, 235, 0.5);
            transform: translateY(-2px);
        }
        .loader {
            border-top-color: #3b82f6;
            -webkit-animation: spinner 1.5s linear infinite;
            animation: spinner 1.5s linear infinite;
        }
        @-webkit-keyframes spinner {
            0% { -webkit-transform: rotate(0deg); }
            100% { -webkit-transform: rotate(360deg); }
        }
        @keyframes spinner {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
    <!-- Firebase Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = 'anonymous';

        // Function to initialize Firebase and sign in
        window.initFirebase = async () => {
            if (!firebaseConfig) {
                console.error("Firebase configuration is missing.");
                return;
            }
            try {
                // setLogLevel('Debug'); // Uncomment for debugging
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        document.getElementById('auth-status').textContent = 'Đã xác thực. User ID: ' + userId.substring(0, 8) + '...';
                        console.log("Firebase initialized. User ID:", userId);
                        // Store Cán Bộ info for auto-fill on next run
                        localStorage.setItem('currentUserId', userId);
                    } else {
                        userId = localStorage.getItem('currentUserId') || crypto.randomUUID(); // Fallback to a random ID
                        document.getElementById('auth-status').textContent = 'Ẩn danh. User ID: ' + userId.substring(0, 8) + '...';
                        console.log("Signed out. Using anonymous ID:", userId);
                    }
                    loadCanBoInfo(); // Load saved Can Bo info after auth setup
                });

                window.db = db; // Attach to window for use in the main script
                window.userId = userId;

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('auth-status').textContent = 'Lỗi xác thực: ' + error.code;
            }
        };

        // Function to save data to Firestore
        window.saveData = async (data) => {
            if (!db || !userId) {
                showToast('Lỗi: Chưa kết nối Firebase hoặc User ID.', 'bg-red-500');
                return false;
            }
            try {
                // Lưu dữ liệu vào collection private của người dùng
                const docRef = await addDoc(collection(db, `/artifacts/${appId}/users/${userId}/hkd_data`), {
                    ...data,
                    timestamp: serverTimestamp(),
                    collector_id: userId,
                });
                showToast('Lưu dữ liệu thành công!', 'bg-green-500');
                return true;
            } catch (e) {
                console.error("Lỗi khi thêm tài liệu vào Firestore: ", e);
                showToast('Lỗi khi lưu dữ liệu vào Firestore.', 'bg-red-500');
                return false;
            }
        };
        
        // Function to show toast notification
        window.showToast = (message, color = 'bg-gray-800') => {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = `fixed bottom-4 left-1/2 transform -translate-x-1/2 ${color} text-white px-4 py-2 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-100`;
            setTimeout(() => {
                toast.classList.remove('opacity-100');
                toast.classList.add('opacity-0');
            }, 3000);
        };

        // Function to save and load Can Bo info using localStorage
        window.saveCanBoInfo = () => {
            const maCB = document.getElementById('Ma_CB').value;
            const tenCB = document.getElementById('Ten_CB').value;
            const emailCB = document.getElementById('Email_CB').value;
            const tenPhong = document.getElementById('Ten_Phong').value;

            if (maCB) {
                localStorage.setItem('canBoInfo', JSON.stringify({ maCB, tenCB, emailCB, tenPhong }));
            }
        };

        window.loadCanBoInfo = () => {
            const savedInfo = localStorage.getItem('canBoInfo');
            if (savedInfo) {
                const info = JSON.parse(savedInfo);
                document.getElementById('Ma_CB').value = info.maCB || '';
                document.getElementById('Ten_CB').value = info.tenCB || '';
                document.getElementById('Email_CB').value = info.emailCB || '';
                document.getElementById('Ten_Phong').value = info.tenPhong || '';
            }
        };
    </script>
</head>
<body onload="initFirebase()">

    <div class="container-mobile">
        <!-- Header -->
        <header class="p-4 bg-blue-600 text-white shadow-lg sticky top-0 z-10 rounded-b-lg">
            <h1 class="text-xl font-bold">Thu Thập Hộ Kinh Doanh</h1>
            <p id="auth-status" class="text-xs mt-1 opacity-80">Đang khởi tạo...</p>
        </header>

        <main class="p-4 flex-grow">
            <!-- Step 1: Thông tin Cán Bộ -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
                    1. Thông tin Cán Bộ (Auto-Saved)
                </h2>
                <div class="space-y-3">
                    <input type="text" id="Ma_CB" placeholder="Mã CB *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                    <input type="text" id="Ten_CB" placeholder="Tên CB" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                    <input type="email" id="Email_CB" placeholder="Email CB" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                    <input type="text" id="Ten_Phong" placeholder="Tên Phòng" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500" onchange="saveCanBoInfo()">
                </div>
            </div>

            <!-- Step 2: Quét/Trích xuất CCCD -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
                    2. Chụp & Trích xuất CCCD
                </h2>
                <input type="file" accept="image/*" capture="camera" id="cccdImageInput" class="hidden" onchange="previewImage('cccdImageInput', 'cccdImagePreview')">
                <button onclick="document.getElementById('cccdImageInput').click()" class="btn-primary w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.868-1.298A2 2 0 0110.456 5h3.088a2 2 0 011.664.89l.868 1.298A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Chụp Ảnh CCCD
                </button>
                <img id="cccdImagePreview" class="mt-3 w-full rounded-lg hidden border-2 border-gray-200">
                
                <button id="extractCCCDButton" onclick="extractText('cccdImageInput', 'cccd')" class="btn-primary w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-3 flex items-center justify-center">
                    <div id="cccdLoader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>
                    Trích Xuất Thông Tin CCCD
                </button>
            </div>

            <!-- Step 3: Thông tin Chủ Hộ (Kết quả Trích xuất) -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H5a2 2 0 00-2 2v9a2 2 0 002 2h14a2 2 0 002-2v-5m-15-6h14a2 2 0 012 2v2a2 2 0 01-2 2H5a2 2 0 01-2-2v-2a2 2 0 012-2z"></path></svg>
                    3. Thông tin Chủ Hộ
                </h2>
                <div class="space-y-3">
                    <input type="text" id="Ho_va_ten" placeholder="Họ và tên *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Gioi_tinh" placeholder="Giới tính" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="date" id="Ngay_sinh" placeholder="Ngày sinh" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="So_Can_cuoc_CCCD" placeholder="Số Căn cước /CCCD *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="date" id="Ngay_cap" placeholder="Ngày cấp" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Noi_cap" placeholder="Nơi cấp" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="email" id="Email" placeholder="Email chủ hộ" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" id="SDT_chu_ho" placeholder="SĐT chủ hộ *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="Dia_chi_chu_ho" placeholder="Địa chỉ chủ hộ" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>

            <!-- Step 4: Chụp & Trích xuất Giấy Đăng ký HKD -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
                    4. Chụp & Trích xuất Đăng Ký HKD
                </h2>
                <input type="file" accept="image/*" capture="camera" id="hkdImageInput" class="hidden" onchange="previewImage('hkdImageInput', 'hkdImagePreview')">
                <button onclick="document.getElementById('hkdImageInput').click()" class="btn-primary w-full bg-indigo-500 hover:bg-indigo-600 text-white font-bold py-3 px-4 rounded-lg flex items-center justify-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.868-1.298A2 2 0 0110.456 5h3.088a2 2 0 011.664.89l.868 1.298A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg>
                    Chụp Ảnh Đăng Ký HKD
                </button>
                <img id="hkdImagePreview" class="mt-3 w-full rounded-lg hidden border-2 border-gray-200">

                <button id="extractHKDButton" onclick="extractText('hkdImageInput', 'hkd')" class="btn-primary w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-4 rounded-lg mt-3 flex items-center justify-center">
                    <div id="hkdLoader" class="hidden loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-6 w-6 mr-2"></div>
                    Trích Xuất Thông Tin HKD
                </button>
            </div>

            <!-- Step 5: Thông tin Hộ Kinh Doanh (Kết quả Trích xuất) -->
            <div class="step-section">
                <h2 class="text-lg font-semibold text-blue-700 mb-4 flex items-center">
                    <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7v4a2 2 0 002 2h4a2 2 0 002-2V7m0 10a2 2 0 002 2H6a2 2 0 01-2-2v-4a2 2 0 012-2h12a2 2 0 012 2v4z"></path></svg>
                    5. Thông tin Hộ Kinh Doanh
                </h2>
                <div class="space-y-3">
                    <input type="text" id="Ten_ho_kinh_doanh" placeholder="Tên hộ kinh doanh" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="So_DKKD" placeholder="Số ĐKKD" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="date" id="Ngay_cap_lan_dau" placeholder="Ngày cấp lần đầu" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Ngay_dieu_chinh_gan_nhat" placeholder="Ngày điều chỉnh gần nhất (nếu có)" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Ma_so_thue" placeholder="Mã số thuế *" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="text" id="Linh_vuc_kinh_doanh" placeholder="Lĩnh vực kinh doanh" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <textarea id="Dia_chi_HKD" placeholder="Địa chỉ HKD" rows="2" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                    <input type="email" id="Email_HKD" placeholder="Email HKD" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    <input type="tel" id="SDT_HKD" placeholder="SĐT HKD" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                </div>
            </div>

            <!-- Step 6: Hành động -->
            <div class="step-section bg-blue-50 border-blue-200 border">
                <button onclick="submitForm()" class="btn-primary w-full bg-green-600 hover:bg-green-700 text-white font-bold py-4 px-4 rounded-lg flex items-center justify-center text-lg">
                    <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                    LƯU DỮ LIỆU & TIẾP TỤC
                </button>
            </div>
        </main>
        
        <footer class="p-3 text-center text-xs text-gray-500">
            Powered by Gemini AI for OCR & Firestore
        </footer>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-lg shadow-xl z-50 transition-opacity duration-300 opacity-0"></div>

    <script type="module">
        // Global functions are attached to window in the module import block
        
        /**
         * Chuyển đổi File ảnh thành base64.
         * @param {File} file - File ảnh từ input.
         * @returns {Promise<string>} Base64 data (không bao gồm prefix).
         */
        const fileToBase64 = (file) => {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => {
                    const base64String = reader.result.split(',')[1];
                    resolve(base64String);
                };
                reader.onerror = (error) => reject(error);
                reader.readAsDataURL(file);
            });
        };

        /**
         * Hiển thị ảnh preview sau khi chụp.
         */
        window.previewImage = (inputId, previewId) => {
            const file = document.getElementById(inputId).files[0];
            const preview = document.getElementById(previewId);
            if (file) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    preview.src = e.target.result;
                    preview.classList.remove('hidden');
                };
                reader.readAsDataURL(file);
            } else {
                preview.src = '';
                preview.classList.add('hidden');
            }
        };

        // Hàm giúp định dạng ngày tháng sang YYYY-MM-DD nếu có thể (cho input type=date)
        const formatDateForInput = (dateString) => {
            if (!dateString) return '';
            // Chuỗi ngày tháng có thể là DD/MM/YYYY, DD-MM-YYYY, hoặc YYYY-MM-DD
            const parts = dateString.match(/(\d{1,4})[/-](\d{1,2})[/-](\d{2,4})/);
            if (parts) {
                const p1 = parts[1]; // Ngày hoặc Năm
                const p2 = parts[2]; // Tháng
                const p3 = parts[3]; // Năm hoặc Ngày

                let year, month, day;

                // Logic đơn giản để đoán định dạng DD/MM/YYYY hoặc MM/DD/YYYY
                // Giả định định dạng phổ biến ở VN là DD/MM/YYYY
                if (p1.length <= 2 && p3.length === 4) { // D/M/YYYY (Phổ biến)
                    day = p1.padStart(2, '0');
                    month = p2.padStart(2, '0');
                    year = p3;
                } else if (p1.length === 4) { // YYYY/MM/DD
                    year = p1;
                    month = p2.padStart(2, '0');
                    day = p3.padStart(2, '0');
                } else { // Trường hợp khác, sử dụng chuỗi gốc và để người dùng chỉnh sửa
                    return dateString;
                }

                return `${year}-${month}-${day}`; 
            }
            // Trả về chuỗi gốc nếu không khớp định dạng, để người dùng tự chỉnh sửa.
            return dateString; 
        };

        /**
         * Gọi API Gemini để trích xuất văn bản từ ảnh.
         * @param {string} inputId - ID của input file.
         * @param {string} docType - Loại tài liệu ('cccd' hoặc 'hkd').
         */
        window.extractText = async (inputId, docType) => {
            const fileInput = document.getElementById(inputId);
            
            // KIỂM TRA QUAN TRỌNG: Đảm bảo có file được chọn
            if (!fileInput.files || fileInput.files.length === 0) {
                showToast('Vui lòng chụp ảnh hoặc chọn file trước khi trích xuất.', 'bg-yellow-500');
                return;
            }

            const loaderId = docType === 'cccd' ? 'cccdLoader' : 'hkdLoader';
            const buttonId = docType === 'cccd' ? 'extractCCCDButton' : 'extractHKDButton';
            const loader = document.getElementById(loaderId);
            const button = document.getElementById(buttonId);
            const originalButtonText = button.textContent.trim();

            // Set loading state
            loader.classList.remove('hidden');
            button.disabled = true;
            button.textContent = (docType === 'cccd' ? 'Đang trích xuất CCCD...' : 'Đang trích xuất HKD...');
            
            try {
                const base64Data = await fileToBase64(fileInput.files[0]);
                
                let prompt;
                let responseSchema;

                if (docType === 'cccd') {
                    // Cập nhật Prompt: Yêu cầu trả về ngày tháng dưới dạng chuỗi nguyên gốc.
                    prompt = `Phân tích văn bản trong ảnh là Căn cước công dân. Trích xuất chính xác các thông tin sau: 1. Họ và tên (FULL_NAME), 2. Giới tính (GENDER), 3. Ngày sinh (BIRTH_DATE), 4. Số Căn cước/CCCD (ID_NUMBER), 5. Ngày cấp (ISSUE_DATE), 6. Nơi cấp (ISSUE_PLACE). Trả lời chỉ dưới dạng JSON.`;
                    responseSchema = {
                        type: "OBJECT",
                        properties: {
                            "FULL_NAME": { "type": "STRING" },
                            "GENDER": { "type": "STRING" },
                            "BIRTH_DATE": { "type": "STRING" },
                            "ID_NUMBER": { "type": "STRING" },
                            "ISSUE_DATE": { "type": "STRING" },
                            "ISSUE_PLACE": { "type": "STRING" }
                        }
                    };
                } else { // HKD
                    // Cập nhật Prompt: Yêu cầu trả về ngày tháng dưới dạng chuỗi nguyên gốc.
                    prompt = `Phân tích văn bản trong ảnh là Giấy đăng ký Hộ kinh doanh. Trích xuất chính xác các thông tin sau: 1. Tên hộ kinh doanh (HKD_NAME), 2. Số ĐKKD (DKKD_NUMBER), 3. Ngày cấp lần đầu (FIRST_ISSUE_DATE), 4. Ngày điều chỉnh gần nhất (LAST_ADJUST_DATE), 5. Mã số thuế (MST), 6. Lĩnh vực kinh doanh (BUSINESS_FIELD), 7. Địa chỉ HKD (HKD_ADDRESS). Trả lời chỉ dưới dạng JSON.`;
                    responseSchema = {
                        type: "OBJECT",
                        properties: {
                            "HKD_NAME": { "type": "STRING" },
                            "DKKD_NUMBER": { "type": "STRING" },
                            "FIRST_ISSUE_DATE": { "type": "STRING" },
                            "LAST_ADJUST_DATE": { "type": "STRING" },
                            "MST": { "type": "STRING" },
                            "BUSINESS_FIELD": { "type": "STRING" },
                            "HKD_ADDRESS": { "type": "STRING" }
                        }
                    };
                }
                
                const apiKey = "";
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

                const payload = {
                    contents: [{
                        role: "user",
                        parts: [
                            { text: prompt },
                            {
                                inlineData: {
                                    mimeType: fileInput.files[0].type,
                                    data: base64Data
                                }
                            }
                        ]
                    }],
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: responseSchema
                    }
                };
                
                // Retry mechanism for API call (Exponential Backoff)
                const maxRetries = 5;
                let attempt = 0;
                let apiResponse;

                while (attempt < maxRetries) {
                    attempt++;
                    try {
                        const response = await fetch(apiUrl, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (!response.ok) {
                             throw new Error(`HTTP error! status: ${response.status}`);
                        }
                        apiResponse = await response.json();
                        if (apiResponse.candidates && apiResponse.candidates.length > 0) {
                            break; // Success
                        } else {
                            // API call succeeded but no candidate was returned (e.g., safety block or empty response)
                            console.error("API returned no candidates:", apiResponse);
                            if (attempt < maxRetries) {
                                await new Promise(resolve => setTimeout(resolve, 2 ** attempt * 1000));
                                continue;
                            } else {
                                throw new Error("API failed to return content after multiple retries.");
                            }
                        }
                    } catch (error) {
                        console.warn(`Attempt ${attempt} failed. Retrying in ${2 ** attempt}s...`);
                        if (attempt < maxRetries) {
                            await new Promise(resolve => setTimeout(resolve, 2 ** attempt * 1000));
                        } else {
                            throw new Error("Failed after multiple retries.");
                        }
                    }
                }
                
                // Process the successful response
                if (apiResponse.candidates && apiResponse.candidates.length > 0) {
                    const jsonText = apiResponse.candidates[0].content.parts[0].text;
                    const result = JSON.parse(jsonText);
                    
                    if (docType === 'cccd') {
                        document.getElementById('Ho_va_ten').value = result.FULL_NAME || '';
                        document.getElementById('Gioi_tinh').value = result.GENDER || '';
                        // Sử dụng hàm formatDateForInput để chuyển đổi định dạng
                        document.getElementById('Ngay_sinh').value = formatDateForInput(result.BIRTH_DATE) || '';
                        document.getElementById('So_Can_cuoc_CCCD').value = result.ID_NUMBER || '';
                        document.getElementById('Ngay_cap').value = formatDateForInput(result.ISSUE_DATE) || '';
                        document.getElementById('Noi_cap').value = result.ISSUE_PLACE || '';
                        showToast('Trích xuất CCCD thành công. Vui lòng kiểm tra lại dữ liệu!', 'bg-green-600');
                    } else {
                        document.getElementById('Ten_ho_kinh_doanh').value = result.HKD_NAME || '';
                        document.getElementById('So_DKKD').value = result.DKKD_NUMBER || '';
                        document.getElementById('Ngay_cap_lan_dau').value = formatDateForInput(result.FIRST_ISSUE_DATE) || '';
                        document.getElementById('Ngay_dieu_chinh_gan_nhat').value = result.LAST_ADJUST_DATE || '';
                        document.getElementById('Ma_so_thue').value = result.MST || '';
                        document.getElementById('Linh_vuc_kinh_doanh').value = result.BUSINESS_FIELD || '';
                        document.getElementById('Dia_chi_HKD').value = result.HKD_ADDRESS || '';
                        showToast('Trích xuất HKD thành công. Vui lòng kiểm tra lại dữ liệu!', 'bg-green-600');
                    }
                } else {
                    showToast('Lỗi API: Không nhận được kết quả trích xuất.', 'bg-red-500');
                }

            } catch (error) {
                console.error("Lỗi trích xuất bằng Gemini:", error);
                // Hiển thị lỗi chi tiết hơn nếu có thể
                showToast(`Lỗi trích xuất: ${error.message || 'Lỗi không xác định'}. Thử lại hoặc nhập thủ công.`, 'bg-red-500');
            } finally {
                // Reset loading state
                loader.classList.add('hidden');
                button.disabled = false;
                button.textContent = originalButtonText;
            }
        };

        /**
         * Thu thập dữ liệu từ Form và gửi lên Firestore.
         */
        window.submitForm = async () => {
            // Lưu thông tin cán bộ trước
            saveCanBoInfo();

            // 1. Thu thập dữ liệu, sử dụng ID khớp với tên cột của bạn (đã loại bỏ dấu)
            const data = {
                // Cán Bộ (Data CB)
                "Ma_CB": document.getElementById('Ma_CB').value,
                "Ten_CB": document.getElementById('Ten_CB').value,
                "Email_CB": document.getElementById('Email_CB').value, // Thêm để lưu vào Firestore
                "Ten_Phong": document.getElementById('Ten_Phong').value, // Thêm để lưu vào Firestore
                
                // Chủ Hộ / HKD (Data HKD)
                "Ho_va_ten": document.getElementById('Ho_va_ten').value,
                "Gioi_tinh": document.getElementById('Gioi_tinh').value,
                "Ngay_sinh": document.getElementById('Ngay_sinh').value,
                "So_Can_cuoc_CCCD": document.getElementById('So_Can_cuoc_CCCD').value,
                "Ngay_cap": document.getElementById('Ngay_cap').value,
                "Noi_cap": document.getElementById('Noi_cap').value,
                "Email": document.getElementById('Email').value,
                "SDT_chu_ho": document.getElementById('SDT_chu_ho').value,
                "Dia_chi_chu_ho": document.getElementById('Dia_chi_chu_ho').value,
                
                "Ten_ho_kinh_doanh": document.getElementById('Ten_ho_kinh_doanh').value,
                "So_DKKD": document.getElementById('So_DKKD').value,
                "Ngay_cap_lan_dau": document.getElementById('Ngay_cap_lan_dau').value,
                "Ngay_dieu_chinh_gan_nhat": document.getElementById('Ngay_dieu_chinh_gan_nhat').value,
                "Ma_so_thue": document.getElementById('Ma_so_thue').value,
                "Linh_vuc_kinh_doanh": document.getElementById('Linh_vuc_kinh_doanh').value,
                "Dia_chi_HKD": document.getElementById('Dia_chi_HKD').value,
                "Email_HKD": document.getElementById('Email_HKD').value,
                "SDT_HKD": document.getElementById('SDT_HKD').value,

                // Thêm các trường tiến độ mặc định
                "Trang_Thai_Tien_Do": "Mới thu thập",
                "Has_CCCD_Image": document.getElementById('cccdImageInput').files.length > 0,
                "Has_HKD_Image": document.getElementById('hkdImageInput').files.length > 0,
            };

            // 2. Kiểm tra dữ liệu cần thiết (Các trường có dấu *)
            if (!data.Ma_CB || !data.Ho_va_ten || !data.So_Can_cuoc_CCCD || !data.SDT_chu_ho || !data.Ma_so_thue) {
                showToast('Vui lòng nhập đủ các trường chính có dấu * (Mã CB, Tên, CCCD, SĐT, MST).', 'bg-red-500');
                return;
            }

            // 3. Lưu vào Firestore
            const success = await saveData(data);

            // 4. Reset Form sau khi lưu thành công
            if (success) {
                // Chỉ reset các trường thông tin HKD/Chủ hộ
                document.getElementById('Ho_va_ten').value = '';
                document.getElementById('Gioi_tinh').value = '';
                document.getElementById('Ngay_sinh').value = '';
                document.getElementById('So_Can_cuoc_CCCD').value = '';
                document.getElementById('Ngay_cap').value = '';
                document.getElementById('Noi_cap').value = '';
                document.getElementById('Email').value = '';
                document.getElementById('SDT_chu_ho').value = '';
                document.getElementById('Dia_chi_chu_ho').value = '';
                document.getElementById('Ten_ho_kinh_doanh').value = '';
                document.getElementById('So_DKKD').value = '';
                document.getElementById('Ngay_cap_lan_dau').value = '';
                document.getElementById('Ngay_dieu_chinh_gan_nhat').value = '';
                document.getElementById('Ma_so_thue').value = '';
                document.getElementById('Linh_vuc_kinh_doanh').value = '';
                document.getElementById('Dia_chi_HKD').value = '';
                document.getElementById('Email_HKD').value = '';
                document.getElementById('SDT_HKD').value = '';
                
                // Ẩn ảnh preview
                document.getElementById('cccdImagePreview').classList.add('hidden');
                document.getElementById('hkdImagePreview').classList.add('hidden');
                
                // Reset file input 
                fileInputReset('cccdImageInput');
                fileInputReset('hkdImageInput');
                
                showToast('Dữ liệu HKD mới đã được lưu và Form đã sẵn sàng cho hộ tiếp theo.', 'bg-green-600');
            }
        };
        
        // Helper function to reset file input
        const fileInputReset = (id) => {
            const input = document.getElementById(id);
            // Gán lại chính nó để reset state, cách tốt nhất để reset input type="file"
            input.value = null; 
        };
        
    </script>
</body>
</html>

